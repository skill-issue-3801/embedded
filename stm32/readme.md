# STM32 Embedded Systems
This the the STM32CubeIDE workspace for the embedded systems relating to the ambient calendar design. The embedded systems handle the button control and NFC token detection system to detect the presence of user tokens. The source code can be found in the `/Core` directory. This project utilises FreeRTOS to handle tasks such as reading from potentiometers and NFC cards and handling serial communication with the Pi concurrently.

## STM32CubeIDE
[STM32CubeIDE](https://www.st.com/en/development-tools/stm32cubeide.html) is the official IDE for programming STM32 chips made by ST Microelectronics. The embedded systems was entirely developed in this IDE. To open this, clone the repository into your file system by running the following command:
```
git clone git@github.com:skill-issue-3801/embedded.git
```

Next, once you have [downloaded](https://www.st.com/en/development-tools/stm32cubeide.html) the IDE and cloned into the git repository. Open the IDE and select open workspace from the File dropdown menu. Select the STM32 folder in the git repository as the workspace. 

## List of Hardware
The Project uses the following hardware.
 * [NUCLEO-L476RG Development Board](https://www.st.com/en/evaluation-tools/nucleo-l476rg.html) by ST Microelectronics
 * [PiicoDev RFID Module (NFC 13.56MHz)](https://core-electronics.com.au/piicodev-rfid-module.html) by Core Electronics
 * [XIAO SAMD21(Seeeduino XIAO)](https://www.seeedstudio.com/Seeeduino-XIAO-Arduino-Microcontroller-SAMD21-Cortex-M0+-p-4426.html) by Seeed Studio
 * [RFID/NFC Tag 25mm Coin (NTAG213 Chip, 13.56MHz)](https://core-electronics.com.au/rfid-nfc-tag-25mm-coin-ntag213-chip-13-56mhz-pack-of-5.html) x 4
 * SPST (Single Pole Single Throw) Switches x 8
 * 5mm Green LEDS x 4
 * 10k Linear Single Gang Potentiometers x 2

### NUCLEO-L476RG
The main HAL and setup exist throughout the workspace. This is automatically generated by the STM32CubeIDE. This board houses the STM32L476rg chip which stands as the main device receiving input from all the controls as well as handling the communication with the Raspberry Pi and NFC module. 

### NFC Module and Tags
The FreeRTOS tasks and Driver for the module exist entirely in the `/Core/Src/MRFC522.c` file, included by the `/Core/Inc/MRFC522.h` header file. The [MFRC522](https://www.nxp.com/docs/en/data-sheet/MFRC522.pdf) module connects to the STM32476rg using the I2C protocol. The implementation of this driver was influenced by the [Arduino driver](https://github.com/miguelbalboa/rfid/tree/master) for the same module. The FreeRTOS task detects when new tags have entered the RF field of the reader, and makes an exchange with the TAG to determine it's ID, matching this with the internal user IDs saved in the code to determine which user has been detected. The tags are [NTAG213](https://core-electronics.com.au/attachments/uploads/NTAG213-215-216.pdf) tags that use the [ISO/IEC14443](http://www.emutag.com/iso/14443-3.pdf) Type A standard. 

### Seeeduino Xiao
As of current this just exists as an external power source for the NFC module. Instead of relying solely on the power from the Nucleo board, this allows the antenna on the NFC module to output the required power to generate the RF field for reading tags. 

## Pinout Diagram
